\documentclass[letterpaper,openany,oneside,twocolumn]{book}

\usepackage{fontspec}
\usepackage[justified]{dnd}
\usepackage{ifthen}
\usepackage{pstricks}

\usepackage[UKenglish]{babel}

\usepackage{dndtemplate}
\usepackage{bookmark}

\setlength\oddsidemargin{\dimexpr(\paperwidth-\textwidth)/2 - 1in\relax}
\setlength\evensidemargin{\oddsidemargin}

% Headline
\CharacterName{[[ char.name ]]}

% adds only main class and total level to prevent overflow
\Class{[[ char.primary_class.name ]] [[ char.level ]]}
\Background{[[ char.background ]]}
\PlayerName{[[ char.player_name ]]}
\Race{[[ char.race ]]}
\Alignment{[[ char.alignment ]]}
\XP{[[ char.xp ]]}

% Ability scores
\StrengthScore{[[ char.strength.value ]]}
\DexterityScore{[[ char.dexterity.value ]]}
\ConstitutionScore{[[ char.constitution.value ]]}
\IntelligenceScore{[[ char.intelligence.value ]]}
\WisdomScore{[[ char.wisdom.value ]]}
\CharismaScore{[[ char.charisma.value ]]}

% Ability modifiers
\StrengthModifier{[[ char.strength.modifier ]]}
\DexterityModifier{[[ char.dexterity.modifier ]]}
\ConstitutionModifier{[[ char.constitution.modifier ]]}
\IntelligenceModifier{[[ char.intelligence.modifier ]]}
\WisdomModifier{[[ char.wisdom.modifier ]]}
\CharismaModifier{[[ char.charisma.modifier ]]}

% Saving Throws
\StrengthSavingThrowModifier{[[ char.strength.saving_throw ]]}
\DexteritySavingThrowModifier{[[ char.dexterity.saving_throw ]]}
\ConstitutionSavingThrowModifier{[[ char.constitution.saving_throw ]]}
\IntelligenceSavingThrowModifier{[[ char.intelligence.saving_throw ]]}
\WisdomSavingThrowModifier{[[ char.wisdom.saving_throw ]]}
\CharismaSavingThrowModifier{[[ char.charisma.saving_throw ]]}

\AcrobaticsSkillModifier{[[ char.acrobatics.modifier ]]}
\AnimalHandlingSkillModifier{[[ char.animal_handling.modifier ]]}
\ArcanaSkillModifier{[[ char.arcana.modifier ]]}
\AthleticsSkillModifier{[[ char.athletics.modifier ]]}
\DeceptionSkillModifier{[[ char.deception.modifier ]]}
\HistorySkillModifier{[[ char.history.modifier ]]}
\InsightSkillModifier{[[ char.insight.modifier ]]}
\IntimidationSkillModifier{[[ char.intimidation.modifier ]]}
\InvestigationSkillModifier{[[ char.investigation.modifier ]]}
\MedicineSkillModifier{[[ char.medicine.modifier ]]}
\NatureSkillModifier{[[ char.nature.modifier ]]}
\PerceptionSkillModifier{[[ char.perception.modifier ]]}
\PerformanceSkillModifier{[[ char.performance.modifier ]]}
\PersuasionSkillModifier{[[ char.persuasion.modifier ]]}
\ReligionSkillModifier{[[ char.religion.modifier ]]}
\SleightOfHandSkillModifier{[[ char.sleight_of_hand.modifier ]]}
\StealthSkillModifier{[[ char.stealth.modifier ]]}
\SurvivalSkillModifier{[[ char.survival.modifier ]]}

% Proficiencies
\SetStrengthProficiency{[% if "strength" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}
\SetDexterityProficiency{[% if "dexterity" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}
\SetConstitutionProficiency{[% if "constitution" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}
\SetIntelligenceProficiency{[% if "intelligence" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}
\SetWisdomProficiency{[% if "wisdom" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}
\SetCharismaProficiency{[% if "charisma" in char.saving_throw_proficiencies %]1[% else %]0[% endif %]}

\SetAcrobaticsProficiency{[%- if char.acrobatics.is_expertise -%]2
                          [%- elif char.acrobatics.is_proficient -%]1
                          [%- elif char.acrobatics.is_jack_of_all_trades -%]0.5
                          [%- elif char.acrobatics.is_remarkable_athlete -%]0.5
                          [% else %]0[% endif %]}
\SetAnimalHandlingProficiency{[%- if char.animal_handling.is_expertise -%]2
                              [%- elif char.animal_handling.is_proficient -%]1
                              [%- elif char.animal_handling.is_jack_of_all_trades -%]0.5
                              [% else %]0[% endif %]}
\SetArcanaProficiency{[%- if char.arcana.is_expertise -%]2
                      [%- elif char.arcana.is_proficient -%]1
                      [%- elif char.arcana.is_jack_of_all_trades -%]0.5
                      [% else %]0[% endif %]}
\SetAthleticsProficiency{[%- if char.athletics.is_expertise -%]2
                         [%- elif char.athletics.is_proficient -%]1
                         [%- elif char.athletics.is_jack_of_all_trades -%]0.5
                         [%- elif char.athletics.is_remarkable_athlete -%]0.5
                         [% else %]0[% endif %]}
\SetDeceptionProficiency{[%- if char.deception.is_expertise -%]2
                         [%- elif char.deception.is_proficient -%]1
                         [%- elif char.deception.is_jack_of_all_trades -%]0.5
                         [% else %]0[% endif %]}
\SetHistoryProficiency{[%- if char.history.is_expertise -%]2
                       [%- elif char.history.is_proficient -%]1
                       [%- elif char.history.is_jack_of_all_trades -%]0.5
                       [% else %]0[% endif %]}
\SetInsightProficiency{[%- if char.insight.is_expertise -%]2
                       [%- elif char.insight.is_proficient -%]1
                       [%- elif char.insight.is_jack_of_all_trades -%]0.5
                       [% else %]0[% endif %]}
\SetIntimidationProficiency{[%- if char.intimidation.is_expertise -%]2
                            [%- elif char.intimidation.is_proficient -%]1
                            [%- elif char.intimidation.is_jack_of_all_trades -%]0.5
                            [%- else %]0[% endif %]}
\SetInvestigationProficiency{[%- if char.investigation.is_expertise -%]2
                             [%- elif char.investigation.is_proficient -%]1
                             [%- elif char.investigation.is_jack_of_all_trades -%]0.5
                             [% else %]0[% endif %]}
\SetMedicineProficiency{[%- if char.medicine.is_expertise -%]
                        [%- elif char.medicine.is_proficient -%]1
                        [%- elif char.medicine.is_jack_of_all_trades -%]0.5
                        [% else %]0[% endif %]}
\SetNatureProficiency{[%- if char.nature.is_expertise -%]2
                      [%- elif char.nature.is_proficient -%]1
                      [%- elif char.nature.is_jack_of_all_trades -%]0.5
                      [% else %]0[% endif %]}
\SetPerceptionProficiency{[%- if char.perception.is_expertise -%]2
                          [%- elif char.perception.is_proficient -%]1
                          [%-elif char.perception.is_jack_of_all_trades -%]0.5
                          [% else %]0[% endif %]}
\SetPerformanceProficiency{[%- if char.performance.is_expertise -%]2
                           [%- elif char.performance.is_proficient -%]1
                           [%- elif char.performance.is_jack_of_all_trades -%]0.5
                           [% else %]0[% endif %]}
\SetPersuasionProficiency{[%- if char.persuasion.is_expertise -%]2
                          [%- elif char.persuasion.is_proficient -%]1
                          [%- elif char.persuasion.is_jack_of_all_trades -%]0.5
                          [% else %]0[% endif %]}
\SetReligionProficiency{[%- if char.religion.is_expertise -%]2
                        [%- elif char.religion.is_proficient -%]1
                        [%- elif char.religion.is_jack_of_all_trades -%]0.5
                        [% else %]0[% endif %]}
\SetSleightOfHandProficiency{[%- if char.sleight_of_hand.is_expertise -%]2
                             [%- elif char.sleight_of_hand.is_proficient -%]1
                             [%- elif char.sleight_of_hand.is_jack_of_all_trades -%]0.5
                             [%- elif char.sleight_of_hand.is_remarkable_athlete -%]0.5
                             [% else %]0[% endif %]}
\SetStealthProficiency{[%- if char.stealth.is_expertise -%]2
                       [%- elif char.stealth.is_proficient -%]1
                       [%- elif char.stealth.is_jack_of_all_trades -%]0.5
                       [%- elif char.stealth.is_remarkable_athlete -%]0.5
                       [% else %]0[% endif %]}
\SetSurvivalProficiency{[%- if char.survival.is_expertise -%]2
                        [%- elif char.survival.is_proficient -%]1
                        [%- elif char.survival.is_jack_of_all_trades -%]0.5
                        [% else %]0[% endif %]}

\Inspiration{[% if char.inspiration %] $\star$ [% endif %]}
\Proficiency{[[ char.proficiency_bonus ]]}
\Perception{[[ 10 + char.perception.modifier ]]}

\ArmorClass{[[ char.armor_class ]]}
\Initiative{[[ char.initiative.replace("+", "") ]]}
\Speed{[[ char.speed ]]}
\MaxHitPoints{[[ char.hp_max ]]}
[% if char.hp_current %]\CurrentHitPoints{[[ char.hp_current ]]}[% endif %]
[% if char.hp_temp %]\TemporaryHitPoints{[[ char.hp_temp ]]}[% endif %]
\MaxHitDice{[[ char.hit_dice.replace(" ","") ]]}
\CurrentHitDice{[[ char.hit_dice_current.replace(" ", "") ]]}

\CP{[% if char.cp > 0 %][[ char.cp ]][% endif %]}
\SP{[% if char.sp > 0 %][[ char.sp ]][% endif %]}
\GP{[% if char.gp > 0 %][[ char.gp ]][% endif %]}
\EP{[% if char.ep > 0 %][[ char.ep ]][% endif %]}
\PP{[% if char.pp > 0 %][[ char.pp ]][% endif %]}

[% for w in char.weapons %]
\AddWeapon{[[ w.name ]]}{[[ "{:+d}".format(w.attack_modifier) ]]}{[[ "{}/{}".format(w.damage, w.damage_type) ]]}
[% endfor %]

\AttacksAdditional{[%- if char.armor -%]\textbf{Armor}: [[ char.armor ]] \\ [%endif %]
                   [%- if char.shield -%]\textbf{Shield}: [[ char.shield ]] \\ [%endif %]
                   [[- char.attacks_and_spellcasting| boxed -]]}

\OtherProficienciesLanguages{\textbf{Languages:} [[ char.languages ]]. \\
[%- for prof_type, values in char.proficiencies_by_type.items() %]
  [%- if not values == "": %]
\textbf{[[ prof_type ]]}: [[ values ]]. \\
  [%- endif -%]
[%- endfor -%]
}

\Equipment{[[ char.equipment_text| boxed -]] \\ \footnotesize{[[ char.weight_and_capacity_text| boxed ]]}}

\PersonalityTraits{[[ char.personality_traits ]]}

\Ideals{[[ char.ideals ]]}

\Bonds{[[ char.bonds ]]}

\Flaws{[[ char.flaws ]]}

\FeaturesTraits{[[ char.features_summary| boxed ]]}


% Appearance

\Age{[[ char.age ]]}
\Height{[[ char.height ]]}
\Weight{[[ char.weight ]]}
\Eyes{[[ char.eyes ]]}
\Skin{[[ char.skin ]]}
\Hair{[[ char.hair ]]}

% background

\CharacterAppearance{[[ portrait ]]
[[- char.appearance_text -]]
}
\AdditionalFeaturesAndTraits{[[ char.additional_description ]]}

\Characterbackground{[[ char.backstory ]]}

\Treasure{[[ char.treasure ]]}

\AlliesAndOrganizations{[[ char.allies ]]}

\OrganizationName{[[ char.org_name ]]}

[% if char.is_spellcaster %]
%Magic
[[ char | spellsheetparser ]]
[% endif %]


\begin{document}
\newgeometry{left=0cm,right=0cm,top=0cm,bottom=0cm}
\onecolumn


% CHARACTER PAGE
\pdfbookmark[0]{Character Sheet}{Character Sheet}
\rendercharactersheet

% BACKSTORY PAGE
\pdfbookmark[0]{Background Sheet}{Background Sheet}
\renderbackgroundsheet

[% if char.is_spellcaster %]
% SPELLCASTING PAGE
\pdfbookmark[0]{Spellcasting Sheet}{Spellcasting Sheet}
\spellsheetchoice
[% endif %]

\end{document}
